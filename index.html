
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Accidents involving the transportation of ethanol from 1985 through 2015</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/metrics-graphics/2.10.1/metricsgraphics.min.css.map" />
    <link rel="stylesheet" href="css/metricgraphics.css" />
    <style>
        #ethanol-map { height: 400px; }
        #acc_table thead tr th {
            border-bottom: 1px solid darkgray;
            cursor: default;
            font-weight: normal;
            padding: 5px 5px 8px 5px;
            font-size: 12px;
        }
        #acc_table td:nth-child(1) {
            font-weight: bold;
        }
        #acc_table td:nth-child(3){
            color: red;
        }
        #acc_table thead tr th {
            border-bottom: 1px solid darkgray;
            cursor: default;
            font-weight: bold;
            padding: 5px 5px 8px 5px;
            text-align: right;
        }
        #acc_table tbody tr td {
            margin: 2px;
            padding: 5px;
            vertical-align: top;
            width: 150px;
            text-align: right;
            font-weight: normal;
            font-size: 12px;
        }
    </style>
</head>
<body onload="javascript:startJS();">
<div class="container">
    <div class="row">
        <div class="page-header">
            <h1>Ethanol Spills, 1985 through 2015</h1>
        </div>
    </div>
    <!-- BODY -->
    <div class="row">
        <div class="col-md-8">
            <p class="lead">Over the past 30 years, ethanol spills have increased tenfold as production and transportation of the biofuel has spiked.</p>
            <p class="lead">Today, ethanol spills happen twice a day in the United States, causing millions of dollars worth of damages and leading to significant injury and loss of life. Spills occur on the West Coast and the East Coast and everywhere in between. They happen near cities and in rural areas. They happen by truck and by rail.</p>
        </div>
        <div class="col-md-4">
            <blockquote>
                <p>"As more and more ethanol is being transported, more and more accidents are going to occur. The potentials for different kinds of accidents are getting higher and higher."</p>
                <footer>Mark Clapp, <cite title="Source">Illinois Fire Service Institute</cite></footer>
            </blockquote>

        </div>
        <div class="col-md-12">
            <p>Use this map to track the increase in ethanol spills from 1985 to 2015. You can see where the spills occurred over the decades and which areas have seen the most incidents. You can click on any year to see how many spills happened up to that point and where the spills had occurred. Below the map, there is a table that shows how many spills occurred in each state, what types of spills these were (rail, highway, etc.) and how many of these caused significant damage.</p>
            <p>You can read a full story about the impact of increased ethanol spills on the Midwest and the dangers of ethanol spills here.</p>
        </div>
    </div>

    <!-- MAP -->
    <div class="row">
        <div class="col-md-12">
            <h2>Frequency of Accidents</h2>
            <div id="ethanol-map"></div>
        </div>
    </div>
    <!-- GRAPHICS -->
    <div class="row" style="margin-top: 50px;">
        <div class="col-md-12" id="dg1"></div>
        <div class="col-md-12" id="dg2"></div>
        <div class="col-md-12" style="margin-top: 50px;">
            <h2>Accidents in Each State</h2>
        </div>
        <div class="col-md-12" id="acc_by_st_table"></div>
    </div>
    <!-- BOTTOM -->
    <div class="row">
        <div class="col-md-12" style="margin-top: 50px;"></div>
    </div>

</div>

<footer class="text-center">
    <div class="container">
        <div class="row">
            <div class="col-xs-12">
                <p style="font-size: .9em;">Graphics and design by Acton H. Gorton</p>
                <p style="font-size: .9em;">Copyright 2016, Midwest Center for Investigative Reporting, investigatemidwest.org</p>
            </div>
        </div>
    </div>
</footer>
<script src="http://code.jquery.com/jquery-3.1.1.slim.min.js"   integrity="sha256-/SIrNqv8h6QGKDuNoLGA4iret+kyesCkHGzVUUV0shc="   crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.7/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/metrics-graphics/2.10.1/metricsgraphics.min.js"></script>
<script src="js/heatmap.min.js"></script>
<script src="js/leaflet-heatmap.js"></script>

<script>
    function startJS() {

        //
        // LEAFLET JS
        //
        var the_map = L.map('ethanol-map', {scrollWheelZoom: false}).setView([39.8282, -98.5795], 4);

        var map_tiles = L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.{ext}', {
            attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            minZoom: 0,
            maxZoom: 20,
            ext: 'png'
        });

        var heatData = {
            max: 8,
            data: []
        };

        var cfg = {
            "radius": 0.3,
            "maxOpacity": .8,
            "scaleRadius": true,
            "useLocalExtrema": true,
            latField: 'lat',
            lngField: 'lon',
            valueField: 'count',
            gradient: {
                '.5': 'violet',
                '.6': 'blue',
                '.7': 'green',
                '.8': 'yellow',
                '.9': 'orange',
                '1': 'red'
            }
        };

        var heatmapLayer = new HeatmapOverlay(cfg);

        map_tiles.addTo(the_map);
        heatmapLayer.addTo(the_map);

        //
        // D3 AND METRICS GRAPHICS
        //
        d3.tsv('ei_geocoded.txt', function (data) {

            //
            // Graphic for Frequency Count
            //
            var freq_data = d3.nest()
                    .key(function (d) {
                        return d.date
                    })
                    .rollup(function (leaves) {
                        return leaves.length
                    })
                    .entries(data);

            freq_data = MG.convert.date(freq_data, 'key');
            heatData.data = data.map(function(record){

                    return {
                        'lat': record.latitude,
                        'lon': record.longitude,
                        'count': d3.sum(record, function(v){ return v })
                    }
            });
            heatmapLayer.setData(heatData);

            MG.data_graphic({
                title: "Frequency of Ethanol Spills from 1985 throughout 2015",
                description: "Spills",
                data: freq_data,
                height: 200,
                width: $("#dg1").width(),
                right: 40,
                target: '#dg1',
                x_accessor: 'key',
                y_accessor: 'value',
                linked: false,
                color: '#8C001A',
                animate_on_load: false,
                y_extended_ticks: true,
                x_label: 'Date',
                y_label: 'Spills',
                y_rug: true,
                mouseover: function(d, i){
                    var x = data.slice(0, i);
                    heatData.data = x.map(function(record){
                        return { 'lat': record.latitude, 'lon': record.longitude, 'count': 1 }
                    });
                    heatmapLayer.setData(heatData);
                }
            });

            //
            // Table Data
            //
            var table_data = d3.nest()
                    .key(function (d) { return d.incident_state })
                    .sortKeys(d3.ascending)
                    .rollup(function (d) {
                        return {
                            'record_count': d.length,
                            'serious': d3.sum(d, function(v){ return v.serious_incident }),
                            'highway': d3.sum(d, function(v){ return ((v.transportation) == "H"? 1:0) }),
                            'rail': d3.sum(d, function(v){ return ((v.transportation) == "R"? 1:0) }),
                            'waterway': d3.sum(d, function(v){ return ((v.transportation) == "W"? 1:0) }),
                            'air': d3.sum(d, function(v){ return ((v.transportation) == "A"? 1:0) }),
                            'freight': d3.sum(d, function(v){ return ((v.transportation) == "F"? 1:0) }),
                        }
                    })
                    .entries(data);

            var state_names = {
                'AK': 'Alaska',
                'AL': 'Alabama',
                'AR': 'Arkansas',
                'AZ': 'Arizona',
                'CA': 'California',
                'CO': 'Colorado',
                'CT': 'Connecticut',
                'DC': 'D.C.',
                'DE': 'Delaware',
                'FL': 'Florida',
                'GA': 'Georgia',
                'HI': 'Hawaii',
                'IA': 'Iowa',
                'ID': 'Idaho',
                'IL': 'Illinois',
                'IN': 'Indiana',
                'KS': 'Kansas',
                'KY': 'Kentucky',
                'LA': 'Louisiana',
                'MA': 'Massachusetts',
                'MD': 'Maryland',
                'ME': 'Maine',
                'MI': 'Michigan',
                'MN': 'Minnesota',
                'MO': 'Missouri',
                'MS': 'Mississippi',
                'MT': 'Montana',
                'NC': 'North Carolina',
                'ND': 'North Dakota',
                'NE': 'Nebraska',
                'NH': 'New Hampshire',
                'NJ': 'New Jersey',
                'NM': 'New Mexico',
                'NV': 'Nevada',
                'NY': 'New York',
                'OH': 'Ohio',
                'OK': 'Oklahoma',
                'OR': 'Oregon',
                'PA': 'Pennsylvania',
                'PR': 'Puerto Rico',
                'RI': 'Rhode Island',
                'SC': 'South Carolina',
                'SD': 'South Dakota',
                'TN': 'Tennessee',
                'TX': 'Texas',
                'UT': 'Utah',
                'VA': 'Virginia',
                'VT': 'Vermont',
                'WA': 'Washington',
                'WI': 'Wisconsin',
                'WV': 'West Virginia',
                'WY': 'Wyoming'
            };

            var acc_table = d3.select("#acc_by_st_table")
                    .append('table')
                    .attr('id', 'acc_table')
                    .attr('class', 'col-md-8 col-md-offset-2');

            var acc_table_head = acc_table.append("thead").append("tr");

            acc_table_head.selectAll("th")
                    .data( function(){ return [
                        "",
                        "Total",
                        "Serious",
                        "Highway",
                        "Railway",
                        "Waterway",
                        "Airway",
                        "Freight Forward"
                    ] })
                    .enter()
                    .append("th")
//                    .attr('style', 'font-weight: bold;')
                    .attr('class', 'col-md-1')
                    .html( function(d){ return d });

            var acc_table_body = acc_table.append("tbody");

            var acc_table_rows = acc_table_body.selectAll("tr")
                    .data(table_data)
                    .enter()
                    .append("tr");

            acc_table_rows.selectAll("td")
                    .data( function(row){ return[
                            state_names[row.key],
                            row.value.record_count,
                            row.value.serious,
                            row.value.highway,
                            row.value.rail,
                            row.value.waterway,
                            row.value.air,
                            row.value.freight
                    ]})
                    .enter()
                    .append("td")
                    .html( function(d){ return d });

        });

    }
</script>
</body>
</html>
